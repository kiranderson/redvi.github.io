<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Руководство по обновлению Gentoo Linux | Заметки на полях</title>
    <meta name="description" content="Обновление системы и совместное с ней существование.">
    <link rel="manifest" href="/manifest.json">
  <link rel="icon" href="/favicon.ico">
  <meta name="theme-color" content="#46bd87">
    
    <link rel="preload" href="/assets/css/0.styles.4993531b.css" as="style"><link rel="preload" href="/assets/js/app.6e4996bc.js" as="script"><link rel="preload" href="/assets/js/4.11d3a3db.js" as="script"><link rel="preload" href="/assets/js/51.351e60fc.js" as="script"><link rel="preload" href="/assets/js/28.785693ad.js" as="script"><link rel="prefetch" href="/assets/js/10.23d584b0.js"><link rel="prefetch" href="/assets/js/11.7e9fc27e.js"><link rel="prefetch" href="/assets/js/12.778cebda.js"><link rel="prefetch" href="/assets/js/13.f9a0865b.js"><link rel="prefetch" href="/assets/js/14.7e9142f5.js"><link rel="prefetch" href="/assets/js/15.81a256d2.js"><link rel="prefetch" href="/assets/js/16.49af5ffe.js"><link rel="prefetch" href="/assets/js/17.b44ee3ae.js"><link rel="prefetch" href="/assets/js/18.5aee35b6.js"><link rel="prefetch" href="/assets/js/19.0db9aae5.js"><link rel="prefetch" href="/assets/js/2.35b2c6bb.js"><link rel="prefetch" href="/assets/js/20.dd2ea1cb.js"><link rel="prefetch" href="/assets/js/21.393c5d86.js"><link rel="prefetch" href="/assets/js/22.56cf0890.js"><link rel="prefetch" href="/assets/js/23.155f85b8.js"><link rel="prefetch" href="/assets/js/24.b74b7cb5.js"><link rel="prefetch" href="/assets/js/25.eae2d23b.js"><link rel="prefetch" href="/assets/js/26.036b3a68.js"><link rel="prefetch" href="/assets/js/27.375f2bdb.js"><link rel="prefetch" href="/assets/js/29.11833701.js"><link rel="prefetch" href="/assets/js/3.a76664f0.js"><link rel="prefetch" href="/assets/js/30.6ecf91ca.js"><link rel="prefetch" href="/assets/js/31.5227900f.js"><link rel="prefetch" href="/assets/js/32.c60ace8f.js"><link rel="prefetch" href="/assets/js/33.b41a62d6.js"><link rel="prefetch" href="/assets/js/34.de1eca42.js"><link rel="prefetch" href="/assets/js/35.6640f8d9.js"><link rel="prefetch" href="/assets/js/36.5ae9284d.js"><link rel="prefetch" href="/assets/js/37.3bd95024.js"><link rel="prefetch" href="/assets/js/38.b492b55b.js"><link rel="prefetch" href="/assets/js/39.217589d9.js"><link rel="prefetch" href="/assets/js/40.f390632a.js"><link rel="prefetch" href="/assets/js/41.2a87ce19.js"><link rel="prefetch" href="/assets/js/42.0078f9a2.js"><link rel="prefetch" href="/assets/js/43.305a1d21.js"><link rel="prefetch" href="/assets/js/44.d68d09d3.js"><link rel="prefetch" href="/assets/js/45.725969ad.js"><link rel="prefetch" href="/assets/js/46.5006191f.js"><link rel="prefetch" href="/assets/js/47.02f0ac47.js"><link rel="prefetch" href="/assets/js/48.a1479944.js"><link rel="prefetch" href="/assets/js/49.f202290e.js"><link rel="prefetch" href="/assets/js/5.260a7e1b.js"><link rel="prefetch" href="/assets/js/50.d4cc05c9.js"><link rel="prefetch" href="/assets/js/52.2d05f9b0.js"><link rel="prefetch" href="/assets/js/53.bff13ad2.js"><link rel="prefetch" href="/assets/js/54.25ee54c4.js"><link rel="prefetch" href="/assets/js/55.9fe9e953.js"><link rel="prefetch" href="/assets/js/56.96ba4927.js"><link rel="prefetch" href="/assets/js/57.4e35a560.js"><link rel="prefetch" href="/assets/js/58.ae2210a1.js"><link rel="prefetch" href="/assets/js/59.8a325a55.js"><link rel="prefetch" href="/assets/js/6.58fecefc.js"><link rel="prefetch" href="/assets/js/60.16b2173a.js"><link rel="prefetch" href="/assets/js/61.9d2a0001.js"><link rel="prefetch" href="/assets/js/62.f563cd8e.js"><link rel="prefetch" href="/assets/js/63.1a72cc0f.js"><link rel="prefetch" href="/assets/js/64.e88ea223.js"><link rel="prefetch" href="/assets/js/65.13f19506.js"><link rel="prefetch" href="/assets/js/66.8c2e411f.js"><link rel="prefetch" href="/assets/js/67.f44e0d12.js"><link rel="prefetch" href="/assets/js/68.ea7ddfd9.js"><link rel="prefetch" href="/assets/js/69.b35d4c71.js"><link rel="prefetch" href="/assets/js/7.28b8ec71.js"><link rel="prefetch" href="/assets/js/70.11072557.js"><link rel="prefetch" href="/assets/js/71.17ae261d.js"><link rel="prefetch" href="/assets/js/8.42c742f4.js"><link rel="prefetch" href="/assets/js/9.3db5d928.js">
    <link rel="stylesheet" href="/assets/css/0.styles.4993531b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="common common--light"><header class="header" data-v-32223a35><a href="/" aria-label="menu" class="hamburger" data-v-7ac966a8><div class="line-h" data-v-7ac966a8></div> <div class="text-wrap" data-v-7ac966a8></div> <svg width="42px" height="42px" viewBox="0 0 42 42" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" data-v-7ac966a8><g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd" data-v-7ac966a8><path id="square" stroke="#000000" width="41" height="41" d="M0.5 0.5 L41.5 0.5 L41.5 41.5 L0.5 41.5 Z" class="bz" data-v-7ac966a8></path></g></svg> <div class="line-h" data-v-7ac966a8></div></a></header> <main class="page content"><article><h1>Руководство по обновлению Gentoo Linux</h1> <div class="content__default"><p>После установки и первоначальной настройки пользователю gentoo
linux, кажется, уже не о чем больше беспокоиться. Разве что о такой
важной вещи как поддержание своей операционной системы в актуальном состоянии. Собственно, этот вопрос и будет затронут сегодня. Детально разберём особенности обновления gentoo, немного поговорим о командах и программах, с которыми не мешало бы разобраться каждому гентушнику, ну и постараемся предугадать и осветить возможные вопросы начинающих пользователей. Начнём, пожалуй.</p> <p>В тексте вы можете видеть сноски, выделенные красным цветом и более мелким по сравнению с основным текстом шрифтом. Дело в том, что пост получился довольно таки объёмным и затрагивает не только сам процесс обновления, но и процесс взаимодействия/сосуществования с gentoo, поэтому пришлось вынести некоторые дополнительные материалы в заключение.</p> <p></p><div class="table-of-contents"><ul><li><a href="#введение">Введение</a></li><li><a href="#часть-1-обновnение">Часть 1. Обновление</a><ul><li><a href="#как-часто-сnедует-обновnяться">Как часто следует обновляться?</a></li><li><a href="#процесс-обновnения-системы">Процесс обновления системы</a></li><li><a href="#обновnение-ядра">Обновление ядра</a></li><li><a href="#есnи-обновиnся-gcc">Если обновился gcc</a></li><li><a href="#есnи-система-доnго-не-обновnяnась">Если система долго не обновлялась</a></li></ul></li><li><a href="#часть-2-основы-сосуществования-с-gentoo">Часть 2. Основы сосуществования с gentoo</a><ul><li><a href="#испоnьзование-оверnеев">Использование оверлеев</a></li><li><a href="#бnокировки">Блокировки</a></li><li><a href="#make-conf">make.conf</a></li><li><a href="#use-фnаги">USE-флаги</a></li><li><a href="#зачем-нужны-ebuild-ы">Зачем нужны ebuild'ы</a></li><li><a href="#что-такое-сnоты">Что такое слоты</a></li></ul></li></ul></div><p></p> <h2 id="введение"><a href="#введение" aria-hidden="true" class="header-anchor">#</a> Введение</h2> <p>На земле Gentoo обновление понимается иначе, чем в большинстве существующих дистрибутивов linux. Gentoo никогда не был предназначен для &quot;классического&quot; способа обновления программ: дождаться нового релиза, скачать его, прожечь, поместить диск в привод и следовать инструкции по обновлению. Такой процесс  вряд ли может удовлетворить опытных пользователей, желающих иметь свежее программное обеспечение. С самого начала, Gentoo был разработан вокруг концепции быстрых последовательных обновлений. В идеале, вы устанавливаете систему один раз, и никогда не беспокоитесь о выпусках: просто следуете инструкциям из Введения в Portage в настольной книге Gentoo, которые объясняют, как сохранить вашу систему в актуальном состоянии. Хотя  иногда вносятся изменения в ядро ​​ОС и требуется его ручное обновление.</p> <p>Но в Gentoo есть и релизы. Новый релиз означает появление нового установочного диска, исправленного и дополненного. Диск содержит актуальные/свежие пакеты для новых установок, иногда реализуются функции, несовместимые с предыдущими выпусками. В таком случае принято говорить о новом профиле. Профиль - набор конфигурационных файлов, хранимых а каталоге <code>/usr/portage/profiles</code>. Профили, устаревающие с появлением новых, хранятся в  <code>/usr/portage/profiles</code> наряду с текущими, но они помечены как устаревшие. Portage уведомит вас о необходимости <a href="http://www.gentoo.org/doc/en/gentoo-upgrading.xml" target="_blank" rel="noopener noreferrer">перехода на новый профиль<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</p> <h2 id="часть-1-обновnение"><a href="#часть-1-обновnение" aria-hidden="true" class="header-anchor">#</a> Часть 1. Обновление</h2> <h3 id="как-часто-сnедует-обновnяться"><a href="#как-часто-сnедует-обновnяться" aria-hidden="true" class="header-anchor">#</a> Как часто следует обновляться?</h3> <p>Не чаще, чем раз в сутки. Более частое обновление просто не имеет смысла. Вообще, обновление сроком до месяца не должно повлечь за собой никаких проблем. Если вы предпочитаете обновлять систему периодом от полугода до примерно восьми месяцев одна проблема будет точно: большое количество пакетов, требующих обновления, и связанные с этим временные затраты. Обновление сроком от года и выше может и, вероятно, потребует <a href="http://www.gentoo.ru/content/kak-obnovit-ochen-staruyu-sistemu" target="_blank" rel="noopener noreferrer">вашего пристального внимания<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</p> <h3 id="процесс-обновnения-системы"><a href="#процесс-обновnения-системы" aria-hidden="true" class="header-anchor">#</a> Процесс обновления системы</h3> <p>Обновление системы состоит из нескольких этапов.</p> <h4 id="первый-этап-обновnение-дерева-портежей-и-иnи-испоnьзуемых-допоnнитеnьных-оверnеев"><a href="#первый-этап-обновnение-дерева-портежей-и-иnи-испоnьзуемых-допоnнитеnьных-оверnеев" aria-hidden="true" class="header-anchor">#</a> Первый этап: обновление дерева портежей и/или используемых дополнительных оверлеев.</h4> <p>Осуществляется командой <code>emerge --sync</code>
(или <code>emerge-webrsync</code>, что позволит сэкономить трафик и время)</p> <h4 id="второй-этап-обновnение-пакетов"><a href="#второй-этап-обновnение-пакетов" aria-hidden="true" class="header-anchor">#</a> Второй этап: обновление пакетов</h4> <p>Обновление установленных программ:</p> <div class="language- extra-class"><pre class="language-text"><code># emerge -pvuND --with-bdeps=y world
</code></pre></div><p>Нужно не полениться и прочесть вывод команды. При необходимости устранить блокировки (дополнить/поправить список USE-флагов в <code>/etc/make.conf</code> и <code>/etc/portage/package.use</code>), согласиться с предлагаемой последовательностью действий или исправить её в соответствии со своими представлениями о здравом смысле.
После чего выполнить обновление:</p> <div class="language- extra-class"><pre class="language-text"><code># emerge -uND world
</code></pre></div><p>Иногда может оказаться полезной опция <code>--with-bdeps=y</code>, которая заставляет обновиться пакеты, требующиеся только во время сборки пакета, даже в том случае, когда пакету, который их вытянул, обновление не требуется.</p> <p>После вышеуказанных действий также может потребоваться обновление конфигурационных файлов, о чём, впрочем, напомнит <code>portage</code>, если вы не будете игнорировать его сообщения. Для этого используем <code>etc-update</code> или <code>dispatch-conf</code>.</p> <h4 id="третий-этап-чистка-системы"><a href="#третий-этап-чистка-системы" aria-hidden="true" class="header-anchor">#</a> Третий этап: чистка системы</h4> <p>Проверка и пересборка битых зависимостей осуществляется командой <code>revdep-rebuild</code>.</p> <p>В случае обновления python'а --- <code>python-updater</code>.</p> <p>Для тех, у кого установлен haskell и/или perl: <code>haskell-updater</code> и <code>perl-cleaner</code> в помощь.</p> <p>Удаление ставших ненужными пакетов:</p> <div class="language- extra-class"><pre class="language-text"><code># emerge -pv --depclean
</code></pre></div><p>Тут не надо полагаться на продвинутость <code>emerge</code> целиком и полностью. Лучше посмотреть не тащит ли <code>depclean</code> лишних пакетов. Особенно актуально для X Window System. У автора в результате её беспечности <code>depclean</code> однажды снёс нужную иксам, но необязательную по мнению emerge библиотеку <code>libXinerama</code>, после чего, как и следует предположить, иксы не запустились. Итак, если <code>depclean</code> хочет удалить нужный пакет -  установите этот пакет явно или пропишите в <code>world</code>, дабы больше его не дёргали. Если удаляет что-то из существенного (gcc, python, возможно xorg) - реконфигурйте систему в соответствии с руководствами с gentoo.org.
Разобравшись с этим, можно избавиться от пакетов, которые больше не требуются:</p> <div class="language- extra-class"><pre class="language-text"><code># emerge --depclean
</code></pre></div><p>Ещё раз проверить на предмет сломанных зависимостей с помощью <code>revdep-rebuild</code>.</p> <p>Удалить неиспользуемые исходники:</p> <div class="language- extra-class"><pre class="language-text"><code># eclean-dist
</code></pre></div><h3 id="обновnение-ядра"><a href="#обновnение-ядра" aria-hidden="true" class="header-anchor">#</a> Обновление ядра</h3> <p>Ядро — особый пакет. И отношения к себе заслуживает особого. Portage удаляет только те файлы, который сам установил. Поэтому после обновления в <code>/usr/src/</code> остаёся каталог <code>kernel-$VERSION</code>, содержащий оставшиеся после сборки ядра временные файлы.</p> <p>Его (как и <code>/lib/modules/$VERSION</code>) можно удалить ручками (но только когда они совсем не нужны, до получения подтверждения полной работоспособности нового ядра категорически рекомендуется оставить возможность загрузки со старым ядром!).</p> <p>Если нет желания каждый раз конфигурировать ядро с нуля, то можно взять за основу существующий конфигурационный файл. Берём из <code>/proc/config.gz</code>.</p> <p>Символьная ссылка <code>/usr/src/linux/</code> должна указывать на каталог, содержащий исходники ядра, которое предполагается собирать. Чтобы это условие выполнялось, потребуется произвести следующие манипуляции:</p> <p>Сразу переключиться на новое ядро с помощью <code>eselect</code>.</p> <div class="language- extra-class"><pre class="language-text"><code>$ eselect kernel list
Available kernel symlink targets:
    [1]   linux-3.6.11-gentoo*
    [2]   linux-3.7.7-gentoo
# eselect kernel set 2
</code></pre></div><p>Проверяем создалась ли автоматически символьная ссылка на новое ядро:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">ls</span> -l /usr/src/linux
lrwxrwxrwx <span class="token number">1</span> root root  /usr/src/linux -<span class="token operator">&gt;</span> linux-3.7.7/
</code></pre></div><p>Отлично! Если это не так, создаём вручную:</p> <div class="language- extra-class"><pre class="language-text"><code># ln -sfn /usr/src/linux-3.7.7 /usr/src/linux
</code></pre></div><p>Собственно, сборка нового ядра:</p> <div class="language- extra-class"><pre class="language-text"><code># cd /usr/src/linux
# zcat /proc/config.gz &gt; .config
# make oldconfig
# make menuconfig
# make &amp;&amp; make modules_install
# cp arch/$ARCH/boot/bzImage /boot/linux-$VERSION
</code></pre></div><p>После сборки нужно подправить в <code>/boot/grub/menu.lst</code> строки с версией ядра (справедливо для загрузчика <code>grub-legacy</code>).</p> <p>Теперь вы сможете загрузиться с новым ядром.</p> <div class="warning custom-block"><p class="custom-block-title">Внимание</p> <p>Возможно, придётся пересобрать некоторые программы,
если они используют свои модули. В частности это относится к <code>virtualbox-modules</code>.
Вы можете сделать это вручную или использовать <code>module-rebuild</code>:</p> <div class="language- extra-class"><pre class="language-text"><code># cd /usr/src/linux
# make modules_prepare
# emerge --ask @module-rebuild
</code></pre></div></div> <h3 id="есnи-обновиnся-gcc"><a href="#есnи-обновиnся-gcc" aria-hidden="true" class="header-anchor">#</a> Если обновился gcc</h3> <p>Согласно методическому руководству при обновлении <code>gcc</code> достаточно переключиться на его новую версию и пересобрать с ним только <code>sys-devel/libtool</code>:</p> <div class="language- extra-class"><pre class="language-text"><code># gcc-config -l
# gcc-config 2
# env-update &amp;&amp; source /etc/profile
# emerge --oneshot libtool
</code></pre></div><h3 id="есnи-система-доnго-не-обновnяnась"><a href="#есnи-система-доnго-не-обновnяnась" aria-hidden="true" class="header-anchor">#</a> Если система долго не обновлялась</h3> <p>Во избежание проблем лучше последовательно выполнить данные ниже рекомендации.</p> <p>Внимательно прочесть новости, которые любезно предоставляет нам emerge при синхронизации</p> <p>Согласно рекомендации обновить <code>portage</code> командой</p> <div class="language- extra-class"><pre class="language-text"><code># emerge -1 portage
</code></pre></div><p>Обновить <code>gcc</code>:</p> <div class="language- extra-class"><pre class="language-text"><code># emerge -1 gcc
</code></pre></div><p>Переключиться на новый компилятор и пересобрать <code>libtool</code></p> <p>Новым компилятором пересобрать <code>system</code>:</p> <div class="language- extra-class"><pre class="language-text"><code># emerge -ave system
</code></pre></div><p>Пересобрать драйвера иксов.</p> <p>Дообновить оставшееся, после чего можно переходить <a href="http://gentoo.ru/content/ustanovil-ya-gentoo-dalshe-chto" target="_blank" rel="noopener noreferrer">к чистке системы<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</p> <h2 id="часть-2-основы-сосуществования-с-gentoo"><a href="#часть-2-основы-сосуществования-с-gentoo" aria-hidden="true" class="header-anchor">#</a> Часть 2. Основы сосуществования с gentoo</h2> <p>Теперь стоило бы рассмотреть вещи, к обновлению не относящиеся, но оттого не менее нужные</p> <h3 id="испоnьзование-оверnеев"><a href="#испоnьзование-оверnеев" aria-hidden="true" class="header-anchor">#</a> Использование оверлеев</h3> <p>Не помешает установить утилиту <code>app-portage/eix</code> для поиска по неустановленным оверлеям. После чего следует сформировать базу пакетов. В последующем эта команда позволит обновлять созданную базу:</p> <div class="language- extra-class"><pre class="language-text"><code># eix-remote update
</code></pre></div><p>Кстати, найти нужный пакет и посмотреть в каком оверлее тот находится
можно <a href="http://gpo.zugaina.org/" target="_blank" rel="noopener noreferrer">здесь<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</p> <p>Теперь нам потребуется <code>layman</code>:</p> <div class="language- extra-class"><pre class="language-text"><code># emerge -av app-portage/layman
</code></pre></div><p>Указываем настройки в <code>/etc/portage/make.conf</code>:</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token builtin class-name">source</span> /var/lib/layman/make.conf
<span class="token assign-left variable">PORTDIR_OVERLAY</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">${PORTDIR_OVERLAY}</span> /usr/local/portage&quot;</span>
</code></pre></div><p>Далее следует обновление списка оверлеев и их просмотр:</p> <div class="language- extra-class"><pre class="language-text"><code># layman --fetch
# layman --list
</code></pre></div><p>Добавить нужный оверлей:</p> <div class="language- extra-class"><pre class="language-text"><code># layman -L | grep my_overlay
# layman --add my_overlay
</code></pre></div><p>Обновить все оверлеи:</p> <div class="language- extra-class"><pre class="language-text"><code># layman -S
</code></pre></div><p>Удалить оверлей, ставший ненужным:</p> <div class="language- extra-class"><pre class="language-text"><code># layman --delete my_overlay
</code></pre></div><p>Перед поиском программ из только что установленного оверлея, следует обновить базу <code>eix</code>:</p> <div class="language- extra-class"><pre class="language-text"><code># eix-update
</code></pre></div><p>Просмотреть все пакеты оверлея (в том числе и установленные вами) также
представляется возможным. Для этого будем использовать команду:</p> <div class="language- extra-class"><pre class="language-text"><code>$ eix --in-overlay $OVERLAY_NAME
</code></pre></div><h3 id="бnокировки"><a href="#бnокировки" aria-hidden="true" class="header-anchor">#</a> Блокировки</h3> <p>Блокировки можно условно разделить на два типа: просто блокировки
(их называют жёсткими) и &quot;недоблокировки&quot; (а эти — мягкими). Первые обозначаются заглавной <code>B</code> и требуют к себе предельного внимания. Тут без вашего вмешательства обновление или же установка пакетов не произойдёт. Иначе говоря, <code>emerge</code> сигнализирует, что не может без вас разобраться.
Вообще, жёсткие блокировки возникают, когда два (и почти никогда больше) пакета не могут быть установлены вместе. Либо вы хотите установить программу, которая требует в зависимотсях более новый пакет, чем тот, что у вас установлен, либо программы выполняют одинаковые функции и вместе сосуществовать не могут. Например, <code>udev</code> и <code>eudev</code>.</p> <ul><li>Как можно поступить:
<ul><li>замаскировать один из пакетов</li> <li>удовлетворить требования emerge. Применительно к вышеуказанным <code>udev/eudev</code>: удалить один из них и поставить другой.</li> <li>устанановить, наплевав на предупрежение. Не стоит этого делать (правда не стоит), но если не послушаетесь, ставьте конфликтующий пакет с ключиком <code>-O</code></li></ul></li></ul> <p>На мягкие блокировки даже не надо тратить своего времени - portage сам разрулит. Обозначаются они <code>b</code>строчной.</p> <h3 id="make-conf"><a href="#make-conf" aria-hidden="true" class="header-anchor">#</a> make.conf</h3> <blockquote><p>Не держись указа аки стенки. К каждому указу надобно и голову приложить. © Пётр I</p></blockquote> <p>Сие предупреждение к тому, чтобы читатель не рвался слепо копировать всё из примера в свой make.conf. Это не убунту, думайте и расширяйте этот файл по мере необходимости. Значений может быть меньше, чем в примере, а может быть намного больше.</p> <p>Пример настройки <code>make.conf</code></p> <table><tbody><tr><th>команда</th> <th>описание, которое можно изменить</th></tr> <tr><td>*CFLAGS=&quot;-march=native -O2 -pipe&quot;*</td> <td>в большинстве случаев лучше поставить
`-march=native`, исключением можно считать использование вами `distcc`. Ключ
`-pipe` позволит меньше обращаться к жёсткому диску при компиляции. Его можно
опустить, если вы намерены подключать `/var/tmp/portage` в `tmpfs`</td></tr> <tr><td>CXXFLAGS=&quot;${CFLAGS}&quot;</td> <td>-</td></tr> <tr><td>CHOST=&quot;x86_64-pc-linux-gnu&quot;</td> <td>-</td></tr> <tr><td>USE=&quot;bindist mmx sse sse2 unicode pdf djvu gtk2 -gnome -qt4 -kde cleartype truetype jpeg jpeg2k png gif encode&quot;</td> <td>используемые USE-флаги</td></tr> <tr><td>MAKEOPTS=&quot;-j3&quot;</td> <td>ускорение процесса компиляции. Рекомендуется устанавливать значение равное количеству ядер +1. Так, пример, данный выше, подойдёт для двухъядерного процессора без поддержки Hyper-threading</td></tr> <tr><td>INPUT_DEVICES=&quot;evdev synaptics&quot;</td> <td>указание на имеющееся оборудование для ввода данных. Synaptics указывается при наличии тачпада</td></tr> <tr><td>VIDEO_CARDS=&quot;intel i915&quot;</td> <td>здесь проживают драйверы для видеокарт/видеокарты. К видеокарте от intel, скорее всего, нужно будет дописать и её модуль. В данном случае для Intel HD 3000 это i915</td></tr> <tr><td>ALSA_CARDS=&quot;hda-intel&quot;</td> <td>а это наша звуковая карта (по состоянию на 2014 год опцию можно не указывать, главное выбрать карту в ядре)</td></tr> <tr><td>GENTOO_MIRRORS = &quot;rsync://gentoo.bloodhost.ru/gentoo-distfiles&quot;</td> <td>зеркало, откуда будем тянуть исходники</td></tr> <tr><td>LINGUAS=&quot;ru en&quot;</td> <td>выбранные языковые настройки</td></tr> <tr><td>PORTAGE_TMPDIR=&quot;/var/tmp&quot;</td> <td>расположение временных файлов</td></tr> <tr><td>BUILD_PREFIX=&quot;/var/tmp/portage&quot;</td> <td>каталог сборки</td></tr> <tr><td>PORTDIR=&quot;/usr/portage&quot;</td> <td>где хранится дерево портежей</td></tr> <tr><td>DISTDIR=&quot;${PORTDIR}/distfiles&quot;</td> <td>исходники приложений</td></tr> <tr><td>PKGDIR=&quot;${PORTDIR}/packages&quot;</td> <td>расположение прекомпилированных пакетов. Для создания такого пакета (например, чтобы установить его на другую машину) следует запустить команду emerge --buildpkgonly или включить buildpkg в FEATHURES, чтобы создавать бинарный пакет каждый раз</td></tr> <tr><td>FEATURES=&quot;parallel-fetch userfetch -distcc -buildpkg ccache&quot;</td> <td>`userfetch` повысит безопасность, позволив скачивать исходники не от рута; `parallel-fetch` нужен для параллельной загрузки пакетов</td></tr> <tr><td>CCACHE_SIZE=&quot;10G&quot;</td> <td>размер кэша</td></tr> <tr><td>CCACHE_DIR=&quot;/var/tmp/ccache&quot;</td> <td>`ccache` способен заметно ускорить перекомпиляцию одних и тех же программ. Ccache сначала нужно установить. В `CCACGE_SIZE` задайте максимальный размер используемого дискового пространства</td></tr> <tr><td>PORTAGE_BINHOST=&quot;ftp://buildhost/gentoo&quot;</td> <td>установка пакетов из какого-либо бинарного репозитория. Для установки готового пакета следует ввести команду `emerge --usepkgonly --getbinpkgonly my_package_name`</td></tr> <tr><td>source &quot;/var/lib/layman/make.conf&quot;</td> <td>использование оверлеев layman</td></tr> <tr><td>PORTDIR_OVERLAY=&quot;${PORTDIR_OVERLAY} /usr/local/portage&quot;</td> <td>для оверлеев, это оговаривалось выше</td></tr> <tr><td>PORTAGE_NICENESS=&quot;16&quot;</td> <td>если при сборке пакетов машина потребляет слишком много системных ресурсов, можно понизить приоритет процесса компиляции, что замедлит сборку, но позволит спокойно работать с другими приложениями во время компиляции. Вы можете изменить значение в диапазоне от -20 до 19, более высокие значения означают меньший приоритет. В примере приоритет = 16</td></tr></tbody></table> <p>Дополнительные сведения можно найти в блоге, курсируя по тегу gentoo, или открыть <code>man make.conf</code> (особое внимание уделите блоку <code>FEATURES</code>, вам понравится).</p> <h3 id="use-фnаги"><a href="#use-фnаги" aria-hidden="true" class="header-anchor">#</a> USE-флаги</h3> <p>Тут всё достаточно тривиально. Большинство флагов определяет выбранный вами профиль. Посмотреть список доступных профилей можно командой</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ eselect profile list:

Available profile symlink targets:
<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>   default/linux/amd64/10.0 *
<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>   default/linux/amd64/10.0/selinux
<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span>   default/linux/amd64/10.0/desktop
<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span>   default/linux/amd64/10.0/desktop/gnome
<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span>   default/linux/amd64/10.0/desktop/kde
<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span>   default/linux/amd64/10.0/developer
<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span>   default/linux/amd64/10.0/no-multilib
<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span>   default/linux/amd64/10.0/server
<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span>   default/linux/amd64/10.0/x32
<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span>  default/linux/amd64/13.0
<span class="token punctuation">[</span><span class="token number">11</span><span class="token punctuation">]</span>  default/linux/amd64/13.0/selinux
<span class="token punctuation">[</span><span class="token number">12</span><span class="token punctuation">]</span>  default/linux/amd64/13.0/desktop
<span class="token punctuation">[</span><span class="token number">13</span><span class="token punctuation">]</span>  default/linux/amd64/13.0/desktop/gnome
<span class="token punctuation">[</span><span class="token number">14</span><span class="token punctuation">]</span>  default/linux/amd64/13.0/desktop/kde
<span class="token punctuation">[</span><span class="token number">15</span><span class="token punctuation">]</span>  default/linux/amd64/13.0/developer
<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span>  default/linux/amd64/13.0/no-multilib
<span class="token punctuation">[</span><span class="token number">17</span><span class="token punctuation">]</span>  default/linux/amd64/13.0/x32
<span class="token punctuation">[</span><span class="token number">18</span><span class="token punctuation">]</span>  hardened/linux/amd64
<span class="token punctuation">[</span><span class="token number">19</span><span class="token punctuation">]</span>  hardened/linux/amd64/selinux
<span class="token punctuation">[</span><span class="token number">20</span><span class="token punctuation">]</span>  hardened/linux/amd64/no-multilib
<span class="token punctuation">[</span><span class="token number">21</span><span class="token punctuation">]</span>  hardened/linux/amd64/no-multilib/selinux
<span class="token punctuation">[</span><span class="token number">22</span><span class="token punctuation">]</span>  hardened/linux/uclibc/amd64
</code></pre></div><p>Можно выбрать дефолтный профиль, а затем задать необходимые USE-флаги. Или
выбрать наиболее подходящий вам профиль и дополнять его.
Перед тем, как установить пакет, просмотрите с какими USE-флагами он может
быть собран и впишите свои значения в <code>/etc/portage/package.use</code>.
Пример:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ emerge -av mirage

This action requires superuser access<span class="token punctuation">..</span>.
Would you like to <span class="token function">add</span> --pretend to options? <span class="token punctuation">[</span>Yes/No<span class="token punctuation">]</span> y
These are the packages that would be merged, <span class="token keyword">in</span> order: Calculating dependencies<span class="token punctuation">..</span>. done<span class="token operator">!</span>
<span class="token punctuation">[</span>ebuild   R    <span class="token punctuation">]</span> media-gfx/mirage-0.9.5.1  <span class="token number">0</span> kB jpeg png gif jpeg2k -gnome
</code></pre></div><p>Допустим, нам нужно, чтобы mirage умел просматривать файлы .png и .jpeg,
а .gif и гном игнорировал. В соответствии с этим пропишем:</p> <div class="language- extra-class"><pre class="language-text"><code># nano /etc/portage/package.use
media-gfx/mirage jpeg png -gif jpeg2k -gnome
</code></pre></div><p>Теперь emerge не потянет ненужных нам зависимостей в следствие чего
сократится время сборки да и места на диске больше останется 😉
Для пересборки пакета с новыми флагами следует добавить ключ <code>--newuse</code>.
Если вы не знаете или не уверены в том, какие флаги выставить, можно получить о каждом из них более подробную информацию. Установите <code>gentoolkit</code> и используйте команду <code>equery uses</code> нужный_пакет:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ equery uses python

--- вывод сокращён --
* Found these USE flags <span class="token keyword">for</span> dev-lang/python-3.2.3:
- - build        <span class="token builtin class-name">:</span> <span class="token operator">!</span><span class="token operator">!</span>internal use only<span class="token operator">!</span><span class="token operator">!</span> DO NOT SET THIS FLAG YOURSELF<span class="token operator">!</span>
- - doc          <span class="token builtin class-name">:</span> Adds extra documentation <span class="token punctuation">(</span>API, Javadoc, etc<span class="token punctuation">)</span>
- - examples     <span class="token builtin class-name">:</span> Install examples, usually <span class="token builtin class-name">source</span> code
- - ipv6         <span class="token builtin class-name">:</span> Adds support <span class="token keyword">for</span> IP version <span class="token number">6</span>
+ + ssl          <span class="token builtin class-name">:</span> Adds support <span class="token keyword">for</span> Secure Socket Layer connections
+ + tk           <span class="token builtin class-name">:</span> Adds support <span class="token keyword">for</span> Tk GUI toolkit
- + wide-unicode <span class="token builtin class-name">:</span> Enable wide Unicode implementation <span class="token function">which</span> uses <span class="token number">4</span>-byte Unicode characters.
- - wininst      <span class="token builtin class-name">:</span> Install Windows executables required
+ + xml          <span class="token builtin class-name">:</span> Add support <span class="token keyword">for</span> XML files
</code></pre></div><ul><li>если набрать команду <code>equery depends пакет</code>, будут указаны все пакеты, зависящие от выбранного</li> <li>когда вы желаете использовать версию программы, отличную от используемой по-умолчанию, воспользуйтесь <a href="http://www.gentoo.org/doc/en/gentoolkit.xml" target="_blank" rel="noopener noreferrer">командой <code>eselect</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>. Например:</li> <li>исходники установленных приложений можно найти по пути <code>/usr/portage/distfiles/</code></li> <li>если нужно лишь загрузить исходники, но не устанавливать программу, используйте флаг <code>--fetchonly</code></li> <li>если у вас установлен python3, пересоберите portage с соответствующим флагом (<code>+python3</code>) для увеличения производительности portage в среднем на 15%.</li></ul> <p>Пример с <code>eselect</code>:</p> <div class="language- extra-class"><pre class="language-text"><code># eselect python list
Available Python interpreters:
    [1]   python2.7
    [2]   python3.2 *
# eselect python set 1
</code></pre></div><h3 id="зачем-нужны-ebuild-ы"><a href="#зачем-нужны-ebuild-ы" aria-hidden="true" class="header-anchor">#</a> Зачем нужны ebuild'ы</h3> <p>Иногда какого-то нужного пакета может не оказаться ни в официальном репозитории
gentoo, ни в каком-либо из оверлеев. В таком случае можно установить готовый (
или написать свой ) ebuild.  Найти готовые ebuild'ы можно на <a href="https://bugs.gentoo.org/" target="_blank" rel="noopener noreferrer">https://bugs.gentoo.org/<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, воспользовавшись строкой поиска. Давайте рассмотрим пример установки плагина <code>save for web</code> для графического редактора gimp.</p> <p>Итак, мы скачали необходимый ebuild. Теперь хорошо бы проверить наличие переменной <code>PORTDIR_OVERLAY</code> в <code>make.conf</code>:</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token assign-left variable">PORTDIR_OVERLAY</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">${PORTDIR_OVERLAY}</span> /usr/local/portage&quot;</span>
</code></pre></div><p>Структура любого оверлея копирует структуру официального дерева Portage: (категория/программа/название_программы-версия.ebuild).
Проверьте наличие директории <code>/usr/local/portage</code>, и если её нет — создайте:</p> <div class="language- extra-class"><pre class="language-text"><code># mkdir -p /usr/local/portage
</code></pre></div><p>Для того, чтобы Portage мог установить наш пакет, требуется digest-файл. Создайте его:</p> <div class="language- extra-class"><pre class="language-text"><code># ebuild /usr/local/portage/category/program/program.ebuild digest
</code></pre></div><p>Применительно к save-for-web это будет выглядеть так:</p> <div class="language- extra-class"><pre class="language-text"><code># ebuild /usr/local/portage/media-gfx/gimp-save-for-web/gimp-save-for-web-9999.ebuild
</code></pre></div><p>При установке такого пакета потребуется внести его в <code>/etc/portage/package.keywords</code>:</p> <div class="language- extra-class"><pre class="language-text"><code>=media-gfx/gimp-save-for-web-9999 **
</code></pre></div><p><code>**</code> - разрешит поставить любую версию пакета, независимо от того, в какой ветке тот находится (в тестовой или стабильной).
И после этого установить:</p> <div class="language- extra-class"><pre class="language-text"><code># emerge -av save-for-web
</code></pre></div><h3 id="что-такое-сnоты"><a href="#что-такое-сnоты" aria-hidden="true" class="header-anchor">#</a> Что такое слоты</h3> <p>В большинстве других дистрибутивов устанавливается лишь одна версия пакета,
в то время как в gentoo используется технология слотов. Пакет просто
присваивает определенный слот своей версии. При установке подобных приложений emerge выведет вам информацию, в которой будет указано какие новые пакеты будут установлены как зависимость устанавливаемого пакета (метапакеты), какие пакеты будут обновлены и какие будут установлены в другой слот. Последние обозначены как <code>[NS]</code>.
Наиболее простой пример - обновление ядра:</p> <div class="language- extra-class"><pre class="language-text"><code>[ebuild NS] sys-kernel/gentoo-sources-3.8.3:3.8.3 [3.8.2:3.8.2]
</code></pre></div><p>В принципе изложенной информации должно хватить для работы без экспериментов и неожиданностей.  Хотя рекомендуется ещё пройтись по форуму на предмет вопроса: <a href="http://gentoo.ru/node/26637" target="_blank" rel="noopener noreferrer">что читать после handbook<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.
На этом сегодня всё. Безоблачной жизни в gentoo, дамы и господа!</p></div> <div class="tags" data-v-1c67afbc><span data-v-1c67afbc>2013</span> 

  <a href="/?tag=linux" data-v-1c67afbc>
    linux
  </a></div> <div class="prev-next" data-v-326f747b><div class="prev-next__prev" data-v-326f747b><a href="/posts/udev/" data-v-326f747b>
      Udisks, udev и все-все-все
    </a></div> <div class="prev-next__between" data-v-326f747b>⤧</div> <div class="prev-next__next" data-v-326f747b><a href="/posts/texreview/" data-v-326f747b>
      Что такое TeX?
    </a></div></div> <!----></article></main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.6e4996bc.js" defer></script><script src="/assets/js/4.11d3a3db.js" defer></script><script src="/assets/js/51.351e60fc.js" defer></script><script src="/assets/js/28.785693ad.js" defer></script>
  </body>
</html>
