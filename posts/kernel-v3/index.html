<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Сборка ядра linux | Заметки на полях</title>
    <meta name="description" content="Основные моменты и способы, касающиеся сборки ядра в linux">
    <link rel="manifest" href="/manifest.json">
  <link rel="icon" href="/favicon.ico">
  <meta name="theme-color" content="#46bd87">
    
    <link rel="preload" href="/assets/css/0.styles.4993531b.css" as="style"><link rel="preload" href="/assets/js/app.6e4996bc.js" as="script"><link rel="preload" href="/assets/js/4.11d3a3db.js" as="script"><link rel="preload" href="/assets/js/3.a76664f0.js" as="script"><link rel="preload" href="/assets/js/28.785693ad.js" as="script"><link rel="prefetch" href="/assets/js/10.23d584b0.js"><link rel="prefetch" href="/assets/js/11.7e9fc27e.js"><link rel="prefetch" href="/assets/js/12.778cebda.js"><link rel="prefetch" href="/assets/js/13.f9a0865b.js"><link rel="prefetch" href="/assets/js/14.7e9142f5.js"><link rel="prefetch" href="/assets/js/15.81a256d2.js"><link rel="prefetch" href="/assets/js/16.49af5ffe.js"><link rel="prefetch" href="/assets/js/17.b44ee3ae.js"><link rel="prefetch" href="/assets/js/18.5aee35b6.js"><link rel="prefetch" href="/assets/js/19.0db9aae5.js"><link rel="prefetch" href="/assets/js/2.35b2c6bb.js"><link rel="prefetch" href="/assets/js/20.dd2ea1cb.js"><link rel="prefetch" href="/assets/js/21.393c5d86.js"><link rel="prefetch" href="/assets/js/22.56cf0890.js"><link rel="prefetch" href="/assets/js/23.155f85b8.js"><link rel="prefetch" href="/assets/js/24.b74b7cb5.js"><link rel="prefetch" href="/assets/js/25.eae2d23b.js"><link rel="prefetch" href="/assets/js/26.036b3a68.js"><link rel="prefetch" href="/assets/js/27.375f2bdb.js"><link rel="prefetch" href="/assets/js/29.11833701.js"><link rel="prefetch" href="/assets/js/30.6ecf91ca.js"><link rel="prefetch" href="/assets/js/31.5227900f.js"><link rel="prefetch" href="/assets/js/32.c60ace8f.js"><link rel="prefetch" href="/assets/js/33.b41a62d6.js"><link rel="prefetch" href="/assets/js/34.de1eca42.js"><link rel="prefetch" href="/assets/js/35.6640f8d9.js"><link rel="prefetch" href="/assets/js/36.5ae9284d.js"><link rel="prefetch" href="/assets/js/37.3bd95024.js"><link rel="prefetch" href="/assets/js/38.b492b55b.js"><link rel="prefetch" href="/assets/js/39.217589d9.js"><link rel="prefetch" href="/assets/js/40.f390632a.js"><link rel="prefetch" href="/assets/js/41.2a87ce19.js"><link rel="prefetch" href="/assets/js/42.0078f9a2.js"><link rel="prefetch" href="/assets/js/43.305a1d21.js"><link rel="prefetch" href="/assets/js/44.d68d09d3.js"><link rel="prefetch" href="/assets/js/45.725969ad.js"><link rel="prefetch" href="/assets/js/46.5006191f.js"><link rel="prefetch" href="/assets/js/47.02f0ac47.js"><link rel="prefetch" href="/assets/js/48.a1479944.js"><link rel="prefetch" href="/assets/js/49.f202290e.js"><link rel="prefetch" href="/assets/js/5.260a7e1b.js"><link rel="prefetch" href="/assets/js/50.d4cc05c9.js"><link rel="prefetch" href="/assets/js/51.351e60fc.js"><link rel="prefetch" href="/assets/js/52.2d05f9b0.js"><link rel="prefetch" href="/assets/js/53.bff13ad2.js"><link rel="prefetch" href="/assets/js/54.25ee54c4.js"><link rel="prefetch" href="/assets/js/55.9fe9e953.js"><link rel="prefetch" href="/assets/js/56.96ba4927.js"><link rel="prefetch" href="/assets/js/57.4e35a560.js"><link rel="prefetch" href="/assets/js/58.ae2210a1.js"><link rel="prefetch" href="/assets/js/59.8a325a55.js"><link rel="prefetch" href="/assets/js/6.58fecefc.js"><link rel="prefetch" href="/assets/js/60.16b2173a.js"><link rel="prefetch" href="/assets/js/61.9d2a0001.js"><link rel="prefetch" href="/assets/js/62.f563cd8e.js"><link rel="prefetch" href="/assets/js/63.1a72cc0f.js"><link rel="prefetch" href="/assets/js/64.e88ea223.js"><link rel="prefetch" href="/assets/js/65.13f19506.js"><link rel="prefetch" href="/assets/js/66.8c2e411f.js"><link rel="prefetch" href="/assets/js/67.f44e0d12.js"><link rel="prefetch" href="/assets/js/68.ea7ddfd9.js"><link rel="prefetch" href="/assets/js/69.b35d4c71.js"><link rel="prefetch" href="/assets/js/7.28b8ec71.js"><link rel="prefetch" href="/assets/js/70.11072557.js"><link rel="prefetch" href="/assets/js/71.17ae261d.js"><link rel="prefetch" href="/assets/js/8.42c742f4.js"><link rel="prefetch" href="/assets/js/9.3db5d928.js">
    <link rel="stylesheet" href="/assets/css/0.styles.4993531b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="common common--light"><header class="header" data-v-32223a35><a href="/" aria-label="menu" class="hamburger" data-v-7ac966a8><div class="line-h" data-v-7ac966a8></div> <div class="text-wrap" data-v-7ac966a8></div> <svg width="42px" height="42px" viewBox="0 0 42 42" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" data-v-7ac966a8><g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd" data-v-7ac966a8><path id="square" stroke="#000000" width="41" height="41" d="M0.5 0.5 L41.5 0.5 L41.5 41.5 L0.5 41.5 Z" class="bz" data-v-7ac966a8></path></g></svg> <div class="line-h" data-v-7ac966a8></div></a></header> <main class="page content"><article><h1>Ядерная физика для домохозяек v.3</h1> <div class="content__default"><p>Достаточно давно была написана отличная статья, послужившая верой и правдой
многим линуксоидам, кто самостоятельно собирал  своё ядро. Называлась
она «Ядерная физика для домохозяек, версия 2». Ранее, когда
деревья были выше, небо голубее, а настольные компьютеры не столь производительны,
сборка ядра под своё железо могла внести весомый вклад в увеличение производительности
железного друга. Теперь это уже не столь важно и в большинстве случаев даже не нужно,
ибо прирост будет незначительным. Да и среднестатистический линуксоид как-то
обмельчал, «скуксился» что ли.</p> <p>Тем не менее, автору захотелось немного обновить информацию о сборке ядра,
за которым уже давно закреплена циферка три.</p> <p></p><div class="table-of-contents"><ul><li><a href="#вступnение-иnи-подготовка-к-сборке-ядра">Вступление или подготовка к сборке ядра</a></li><li><a href="#general-setup">General setup</a></li><li><a href="#enable-loadable-module-support">Enable loadable module support</a></li><li><a href="#enable-the-block-layer">Enable the block layer</a></li><li><a href="#processor-type-and-features">Processor type and features</a></li><li><a href="#power-management-and-acpi-options">Power management and ACPI options</a></li><li><a href="#bus-options-pci-etc">Bus options (PCI etc.)</a></li><li><a href="#executable-file-formats-emulations">Executable file formats / Emulations</a></li><li><a href="#networking-support">Networking support</a></li><li><a href="#device-drivers">Device Drivers</a></li><li><a href="#firmware-drivers">Firmware Drivers</a></li><li><a href="#file-systems">File systems</a></li><li><a href="#kernel-hacking">Kernel hacking</a></li><li><a href="#security-options">Security options</a></li><li><a href="#cryptographic-api">Cryptographic API</a></li><li><a href="#virtualization">Virtualization</a></li><li><a href="#library-routines">Library routines</a></li><li><a href="#посnесnовие">Послесловие</a></li></ul></div><p></p> <h2 id="вступnение-иnи-подготовка-к-сборке-ядра"><a href="#вступnение-иnи-подготовка-к-сборке-ядра" aria-hidden="true" class="header-anchor">#</a> Вступление или подготовка к сборке ядра</h2> <p>Для сборки можно использовать ядро с <a href="http://kernel.org/" target="_blank" rel="noopener noreferrer">kernel.org<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.
Если вам удобнее собрать ядро, поставляемое с вашим дистрибутивом, вы можете
смело пропустить этот шаг.</p> <p>Пройдите по указанной выше ссылке и скачайте ядро <code>Latest Stable Kernel</code>.
Должен скачаться файл примерно с таким наименованием: <code>linux-3.6.11.tar.bz2</code>.</p> <p>Помимо этого, иногда вам может понадобиться поставить заплатки для ядра. Если
вы не знаете, что это, значит оно вам и не нужно. Хотя мы рассмотрим процесс
наложения заплаток для полноты картины. Получить их можно всё на том же сайте.</p> <p>Рекомендация по собственно сборке ядра одна на все дистрибутивы, что естественно.
А вот инструмент для сборки вполне возможно, что придётся доустановить.
Для gentoo это пакет <code>gentoo-sources</code> (если предполагается сборка дистрибутивного
ядра). Для дебиана понадобится установить
<a href="https://wiki.debian.org/BuildADebianKernelPackage" target="_blank" rel="noopener noreferrer">целую пачку пакетов<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>,
для арча  понадобится <a href="https://wiki.archlinux.org/index.php/Kernels/Traditional_compilation" target="_blank" rel="noopener noreferrer">эта инструкция<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</p> <p>Перед сборкой неплохо сесть и подумать какое же ядро собрать. Ядро может быть:</p> <p><strong>- монолитным</strong></p> <p>такое ядро полностью грузится при старте системы и остаётся в оперативной памяти
до выключения машины. Его компоненты нельзя изменить, невозможно подгружать и
выгружать модули благодаря чему ядро становится нечувствительным к различным
троянским программам, направленным на подмену оригинальных модулей своими - это
просто невозможно. Но с другой стороны монолитность ядра привносит и некоторые минусы,
такие как невозможность установить стороннюю прошивку или проприетарный драйвер для
видеокарты (ведь его модуль нельзя будет подгрузить!). То есть для домашних машин
лучше не использовать монолитные ядра, а вот для серверов - самое оно.</p> <p><strong>- модульным</strong></p> <p>это ядро напротив позволит включать многие компоненты не жёстко, а модульно
(соответственно своему названию), что уменьшит размер ядра и сделает возможным...
да, загрузку и выгрузку нужных модулей. В готовых дистрибутивах для создания такого
ядра используется initramfs (раньше - initrd). Но при сборке под себя можно обойтись
и без него, достаточно лишь жёстко встроить поддержку файловой системы и контроллёра
HD корневого раздела для того, чтобы система смогла определить их и загрузиться.</p> <div class="tip custom-block"><p class="custom-block-title">На заметку</p> <p>в чём разница между initrd и initramfs http://teleology.mobi/ru/news_ru/15032006-01_ru.</p></div> <p>Обычно предлагается включить в ядро жёстко те компоненты, которые нужны вам постоянно,
а те, что предполагается использовать время от времени, включить модулями.</p> <p>Итак, вы скачали ядро и заплатки. Переместите их в каталог <code>/usr/src/</code> и
сами перейдите в него. Теперь следует распаковать исходники ядра и архивы с заплатками, наложить
заплатки:</p> <div class="language- extra-class"><pre class="language-text"><code># tar xvf linux-3.6.11.tar.bz2
# cp patch-3.6.11.bz2 linux-3.6.11/
# bzip2 -d patch-3.6.11.bz2
# patch -p1 -i patch-3.6.11.bz2
</code></pre></div><p>При наложении заплаток есть лишь один нюанс: сначала накладывается заплатка
для обновления версии ядра (<code>patch-$VERSION.bz2</code> как дано выше) и уже затем
все остальные.</p> <p>Обратите внимание на вывод команды <code>patch</code>. Если заплатка идеально подходит к
ядру, то в выводе должны быть только строчки <code>patching file ...</code> .
Строка <code>Hunk #1 succeeded at...</code> означает что заплатка наложена успешно,
но место наложения сдвинуто на несколько строк. Если же вы увидите
слово <code>Failed</code> —  заплатка не подходит. Лучше удалить каталог <code>linux-3.6.11/</code>
и начать все сначала уже без этой заплатки.</p> <p>Далее могут выполнены следующие команды:</p> <p><code>make mrproper</code> - очистит каталог от мусора предыдущей сборки</p> <p><code>make menuconfig</code> - запустит окно настроек ядра</p> <p><code>[ * ]</code> - опция включена жёстко</p> <p><code>[M]</code> - опция включена модульно</p> <p><code>[ ]</code> - опция отключена</p> <p>Вы можете воспользоваться поиском по параметрам ядра, для этого
нажмите <code>&quot;/&quot;</code> (слеш) и введите искомое. Также не забывайте о справке:
остановитесь на параметре, подробное описание которого вам хотелось бы видеть,
и выбирайте <code>&quot;Help&quot;</code> внизу экрана.</p> <h2 id="general-setup"><a href="#general-setup" aria-hidden="true" class="header-anchor">#</a> General setup</h2> <p>Содержит общие настройки</p> <p><img src="/assets/img/general.jpg" alt="gen"></p> <div class="language- extra-class"><pre class="language-text"><code>[*] Prompt for development and/or incomplete code/drivers
</code></pre></div><p>Некоторые вещи, которые поддерживает Linux (таких, как сетевые драйверы,
файловые системы, сетевые протоколы и т.д.) могут находиться в состоянии
разработки, где функциональность, стабильность или уровень тестирование еще
не достаточно высоки для общего использования. То есть данная опция включает
дополнительные экспериментальные настройки. Рекомендуется включить, чтобы
отображались все доступные опции.</p> <div class="language- extra-class"><pre class="language-text"><code>()  Local version - append to kernel release
</code></pre></div><p>Сюда можно внести наименование, которым дополнится название вашего ядра.
Бывает полезно, когда вы собираете несколько ядер одной и той же версии. Обычно не нужно.</p> <div class="language- extra-class"><pre class="language-text"><code>Kernel compression mode (Gzip)  ---&gt;
  (X) Gzip
  ( ) Bzip2
  ( ) LZMA
  ( ) XZ
  ( ) LZO
</code></pre></div><p>Доступные алгоритмы сжатия, отличающиеся по скорости, эффективности,
компрессии и декомпрессии. Скорость сжатия имеет значение только при сборке ядра.</p> <div class="language- extra-class"><pre class="language-text"><code>[*] Support for paging of anonymous memory (swap)
</code></pre></div><p>Поддержка ядром своп-файла. Включаем.</p> <div class="language- extra-class"><pre class="language-text"><code>[*] System V IPC
    [*] POSIX Message Queues
    [*] BSD Process Accounting
    [ ] BSD Process Accounting version 3 file format
</code></pre></div><p><code>System V IPC</code> — механизм связи между процессами. Набор библиотечных
функций и вызовов ядра, позволяющий процессам обмениваться информацией. Некоторые
программы требуют этого механизма.</p> <p><code>POSIX Message Queues</code> — очередь для сообщений формата POSIX с использованием
приоритетов. Часть механизма связи между процессами. Нужно, если запускать программы написанные под этот формат, например с ОС Solaris.</p> <p><code>BSD Process Accounting</code> — поддержка дополнительных сведений о процессах
(время запуска, владелец, командная строка запуска, использование памяти).
Полезно для контроля процессов.</p> <div class="language- extra-class"><pre class="language-text"><code>[*] Auditing support
    [*] Enable system-call auditing support
    [ ] Make audit loginuid immutable
</code></pre></div><p><code>Auditing support</code> — включение механизма проверки ядра. Например
используется системой SELinux (система расширенной безопасности для Linux).</p> <p><code>Enable system-call auditing support</code> — включение системных вызовов для
механизма проверки ядра.</p> <div class="language- extra-class"><pre class="language-text"><code>&lt;*&gt; Kernel .config support
</code></pre></div><p>Сохранять настройки ядра в нем самом. Это полезно, если у Вы удалите папку с
исходниками ядра, а потом захотите немного изменить ядро.</p> <div class="language- extra-class"><pre class="language-text"><code>[*] Enable access to .config through /proc/config.gz
</code></pre></div><p>Если эта опция включена, вы сможете получать параметры текущего ядра из
<code>/proc/config.gz</code></p> <p>Рекомендуется включить. Пригодится.</p> <div class="language- extra-class"><pre class="language-text"><code>[*] Control Group support  ---&gt;

    [ ] Example debug cgroup subsystem
    [*] Freezer cgroup subsystem
    [ ] Device controller for cgroups
    [*] Cpuset support
    [*] Include legacy /proc/&lt;pid&gt;/cpuset file
    [*] Simple CPU accounting cgroup subsystem
    [*] Resource counters
    [ ] Memory Resource Controller for Control Groups
    [ ] HugeTLB Resource Controller for Control Groups
    [ ] Enable perf_event per-cpu per-container group
    [*] Group CPU scheduler  ---&gt;
        [*] Group scheduling for SCHED_OTHER
        [ ] Group scheduling for SCHED_RR/FIFO
    [ ] Block IO controller
</code></pre></div><p>Поддержка группирования процессов. Используется такими подсистемами как CPUSETS,
CFS, контроль памяти или устройства изоляции.</p> <div class="language- extra-class"><pre class="language-text"><code>-*- Namespaces support  ---&gt;
</code></pre></div><p>Позволяет двум процессам в разных виртуальных средах иметь один и тот же <code>pid</code>.
Эта возможность делает реальными такие сценарии, как апгрейд сервера без необходимости его перезагрузки.</p> <div class="language- extra-class"><pre class="language-text"><code>-*- Kernel-&gt;user space relay support (formerly relayfs)
</code></pre></div><p>Включает поддержку интерфейса некоторых файловых систем (таких как debugfs). Предназначена для эффективного механизма передачи больших объёмов данных из пространства ядра в пользовательское пространство.</p> <div class="language- extra-class"><pre class="language-text"><code>[*] Initial RAM filesystem and RAM disk (initramfs/initrd) support
</code></pre></div><p>Поддержка initrd/initramfs.</p> <p>Если собирается ядро без оных, следует отключить опцию.</p> <div class="language- extra-class"><pre class="language-text"><code>[ ] Optimize for size
</code></pre></div><p>Оптимизация кода ядра по размеру. Может быть полезно для создания загрузочных дискет. В обычных случаях не требуется.</p> <div class="language- extra-class"><pre class="language-text"><code>[ ] Profiling support
</code></pre></div><p>Включение расширенной поддержки профилирования (например, OProfile). Обычно не нужно.</p> <h2 id="enable-loadable-module-support"><a href="#enable-loadable-module-support" aria-hidden="true" class="header-anchor">#</a> Enable loadable module support</h2> <p><img src="/assets/img/module-support.jpg" alt="loadable"></p> <div class="language- extra-class"><pre class="language-text"><code>[ ] Forced module loading
[*] Module unloading
[*] Forced module unloading
[ ] Module versioning support
[ ] Source checksum for all modules
</code></pre></div><p>Создание модульного ядра. <code>Module unloading</code> — возможность выгрузки модулей.</p> <p><code>Forced module unloading</code> — возможность принудительной выгрузки модуля, даже если оно еще нужно ядру</p> <h2 id="enable-the-block-layer"><a href="#enable-the-block-layer" aria-hidden="true" class="header-anchor">#</a> Enable the block layer</h2> <p><img src="/assets/img/block.png" alt="block"></p> <p>Поддержка блочных устройств. Если эта опция отключена, некоторые файловые системы станут недоступны (например, ext3), SCSI и USB устройства не смогут распознаться.</p> <div class="language- extra-class"><pre class="language-text"><code>[*] Block layer SG support v4
  Partition Types  ---&gt;
    [*] Advanced partition selection
    [ ] Macintosh partition map support
    [*] PC BIOS (MSDOS partition tables) support
    [ ] BSD disklabel (FreeBSD partition tables) support
    [ ] SGI partition support
    [ ] EFI GUID Partition support
</code></pre></div><p>Следует выбрать из списка типы разделов, поддержка которых вам необходима. PC BIOS для машин с обычным BIOS (на разделах MBR), EFI GUID — EFI BIOS (на разделах GPT). В общем, ясно из названий.</p> <h2 id="processor-type-and-features"><a href="#processor-type-and-features" aria-hidden="true" class="header-anchor">#</a> Processor type and features</h2> <p><img src="/assets/img/processor.jpg" alt="processors"></p> <div class="language- extra-class"><pre class="language-text"><code>[*] Symmetric multi-processing support
</code></pre></div><p>Поддержка симметричной мультипроцессорности. Включается в случае, если у вас
многопроцессорный компьютер или многоядерный процессор.</p> <div class="language- extra-class"><pre class="language-text"><code>Preemption Model (Voluntary Kernel Preemption (Desktop)) ---&gt;
  Voluntary Kernel Preemption (Desktop)
</code></pre></div><p>Повысит отзывчивость десктопных приложений. Как отметил в комментариях <em>UlvHare</em> в плане
запуска таких приложений как Firefox Low-Latency Desktop Preemptible Mode хуже, чем Voluntary.</p> <div class="language- extra-class"><pre class="language-text"><code>[*] Enable MPS table
</code></pre></div><p>Для старых систем SMP, которые не имеют надлежащей поддержки ACPI.</p> <div class="language- extra-class"><pre class="language-text"><code>[ ] Support for extended (non-PC) x86 platforms
</code></pre></div><p>Поддержка платформ, отличных от PC.</p> <div class="language- extra-class"><pre class="language-text"><code>[ ] Paravirtualized guest support  ---&gt;
</code></pre></div><p>Поддержка паравиртуализации (например, для Xen).</p> <div class="language- extra-class"><pre class="language-text"><code>Processor family (Core 2/newer Xeon)  ---&gt;

  ( ) Opteron/Athlon64/Hammer/K8
  ( ) Intel P4 / older Netburst based Xeon
  (X) Core 2/newer Xeon
  ( ) Intel Atom
  ( ) Generic-x86-64
</code></pre></div><p>Следует выбрать тип своего процессора. Если не знаете или рассчитываете использовать созданную конфигурацию ядра на разных машинах, отмечайте Generic.</p> <div class="language- extra-class"><pre class="language-text"><code>[*] SMT (Hyperthreading) scheduler support
</code></pre></div><p>Включение технологии Hyperthreading.</p> <div class="language- extra-class"><pre class="language-text"><code>[*] Multi-core scheduler support
</code></pre></div><p>Для процессоров Intel Core, AMD Athlon64/Phenom.</p> <div class="language- extra-class"><pre class="language-text"><code>[ ] EFI runtime service support
[ ] EFI stub support
</code></pre></div><p>Для поддержки UEFI. В данном примере она отключена.</p> <h2 id="power-management-and-acpi-options"><a href="#power-management-and-acpi-options" aria-hidden="true" class="header-anchor">#</a> Power management and ACPI options</h2> <p><img src="/assets/img/power.jpg" alt="power"></p> <div class="language- extra-class"><pre class="language-text"><code>[*] Suspend to RAM and standby
</code></pre></div><p>Поддержка Suspend to RAM - сохранение состояния операционной системы в оперативной памяти.</p> <div class="language- extra-class"><pre class="language-text"><code>[*] Hibernation (aka 'suspend to disk')
()  Default resume partition
</code></pre></div><p>Поддержка Suspend to Disk - иначе говоря, режим гибернации. Потребуется включение swap-раздела. В <code>Default resume partition</code> можно прописать путь к swap. Или оставить пустым с последующим внесением параметра resume в строку загрузчика. Лучше прописать к загрузчику.</p> <div class="language- extra-class"><pre class="language-text"><code>[*] ACPI(Advanced Configuration and Power Interface)Support ---&gt;
    &lt;M&gt; EC read/write access through /sys/kernel/debug/ec
    [ ] Deprecated /proc/acpi/event support
    &lt;M&gt; AC Adapter
    &lt;M&gt; Battery
    {M} Button
    {M} Video
    &lt;M&gt; Fan
    [*] Dock
    &lt;M&gt; Processor
    &lt;M&gt; Thermal Zone
</code></pre></div><p>Поддержка интерфейса управления конфигурацией и питанием (ACPI).</p> <div class="language- extra-class"><pre class="language-text"><code>CPU Frequency scaling  ---&gt;
  [*] CPU Frequency scaling
  &lt; &gt; CPU frequency translation statistics
  Default CPUFreq governor (ondemand)  ---&gt;
  -*- 'performance' governor
  &lt; &gt; 'powersave' governor
  &lt; &gt; 'userspace' governor
  -*- 'ondemand' cpufreq policy governor
  &lt; &gt; 'conservative' cpufreq governor
</code></pre></div><p>Управление настройками частоты процессора: <code>'performance'</code> governor обеспечивает наибольшую производительность, <code>'powersave'</code> governor будет стараться снижать частоту процессора, чем увеличит работу от батареи, <code>'ondemand'</code> - нечто среднее. Рекомендуется выбрать <code>'ondemand'</code> в качестве &quot;умолчательного&quot; в  <code>Default CPUFreq governor</code>.</p> <h2 id="bus-options-pci-etc"><a href="#bus-options-pci-etc" aria-hidden="true" class="header-anchor">#</a> Bus options (PCI etc.)</h2> <p><img src="/assets/img/bus.jpg" alt="bus"></p> <div class="language- extra-class"><pre class="language-text"><code>[*] PCI support
[*] Support mmconfig PCI config space access
[*] PCI Express support
&lt; &gt; PCI Express Hotplug driver
[*] Root Port Advanced Error Reporting support
</code></pre></div><p>PCI support обеспечивает поддержку шины PCI.</p> <div class="language- extra-class"><pre class="language-text"><code>&lt;*&gt; PCCard (PCMCIA/CardBus) support  ---&gt;
</code></pre></div><p>Поддержка карт PCMCIA. Чаще всего встречаются на ноутбуках.</p> <div class="language- extra-class"><pre class="language-text"><code>&lt;*&gt; Support for PCI Hotplug  ---&gt;
</code></pre></div><p>&quot;Горячее&quot; (на лету) подключение PCI-устройств. Позволяет добавлять и удалять PCI-устройства, даже когда машина включена и работает. В принципе, можно и отключить, поскольку чаще всего эта возможность не используется.</p> <h2 id="executable-file-formats-emulations"><a href="#executable-file-formats-emulations" aria-hidden="true" class="header-anchor">#</a> Executable file formats / Emulations</h2> <p><img src="/assets/img/emulations.jpg" alt="exec"></p> <div class="language- extra-class"><pre class="language-text"><code>[*] Kernel support for ELF binaries
[*] Write ELF core dumps with partial segments
&lt;*&gt; Kernel support for MISC binaries
[*] IA32 Emulation
</code></pre></div><p>Поддержка формата исполняемых файлов ELF. Обязательна к включению.</p> <h2 id="networking-support"><a href="#networking-support" aria-hidden="true" class="header-anchor">#</a> Networking support</h2> <p><img src="/assets/img/network.png" alt="net"></p> <div class="language- extra-class"><pre class="language-text"><code>Networking options  ---&gt;
</code></pre></div><p>В подпунктах включается поддержка протокола TCP/IP, в частности возможность включения/отключения IPv6. Поскольку автор не является специалистом в данной области, детально раздел не рассматривается. Сетевые администраторы, безусловно, найдут для себя множество полезных опций. Для домашнего же использования рекомендуется оставить опции по-умолчанию.</p> <div class="language- extra-class"><pre class="language-text"><code>&lt; &gt;   IrDA (infrared) subsystem support  ---&gt;
</code></pre></div><p>Скорее всего включать не понадобится. Обеспечивает поддержку инфракрасного модуля.</p> <div class="language- extra-class"><pre class="language-text"><code>&lt; &gt;   Bluetooth subsystem support  ---&gt;
        Bluetooth device drivers  ---&gt;
</code></pre></div><p>Для тех, у кого встроен модуль беспроводной передачи данных bluetooth. Как правило, сейчас это ноутбуки. Хотя ранее bluetooth был достаточно популярен и соответствующие устройства покупались и использовались на настольных ПК.</p> <p><code>Bluetooth device drivers</code> позволит выбрать из списка поддержку определённого устройства.</p> <div class="language- extra-class"><pre class="language-text"><code>&lt;M&gt;   RF switch subsystem support  ---&gt;
</code></pre></div><p>Для ноутбуков, где, как правило, радиопередатчик wifi-чипа включается нажатием клавиши  &quot;Kill Switch&quot;. Если эта клавиша не нажата и передатчик не включен, wi-fi не заведётся. Кстати, если параллельно у вас установлена Windows, обязательно оставьте под ней включенной кнопку wi-fi. В противном случае в linux при попытке включить интерфейс wlan вам будут объяснять, что Kill Switch отключен и включать его будет бесполезно.</p> <div class="language- extra-class"><pre class="language-text"><code>-*-   Wireless  ---&gt;
    &lt;M&gt; cfg80211 - wireless configuration API
    [*] cfg80211 wireless extensions compatibility
</code></pre></div><p>Поддержка стандарта 802.11 для беспроводных сетей.</p> <h2 id="device-drivers"><a href="#device-drivers" aria-hidden="true" class="header-anchor">#</a> Device Drivers</h2> <p><img src="/assets/img/device.jpg" alt="device"></p> <div class="language- extra-class"><pre class="language-text"><code>Generic Driver Options  ---&gt;
    (/sbin/hotplug) path to uevent helper
    [*] Maintain a devtmpfs filesystem to mount at /dev
    [*] Automount devtmpfs at /dev, after the kernel mounted the ro
    [*] Select only drivers that don't need compile-time external fir
    [*] Prevent firmware from being built
     -*- Userspace firmware loading support
    [*] Include in-kernel firmware blobs in kernel binary
    () External firmware blobs to build into the kernel binary
    [ ] Driver Core verbose debug messages
    [*] Managed device resources verbose debug messages
</code></pre></div><p><code>Maintain a devtmpfs filesystem to mount at /dev</code> — Монтировать файловую систему tmpfs.</p> <p><code>Select only drivers that don't need compile-time external fir</code> — выбирать лишь те драйверы, которые не требуют прошивки. В зависимости от вашего оборудования эту опцию, возможно, придётся отключить.</p> <p><code>Include in-kernel firmware blobs in kernel binary</code> — включить прошивку в ядро.</p> <p><code>External firmware blobs to build into the kernel binary</code> — требуется для указания пути к блобам.</p> <p>Например:</p> <div class="language- extra-class"><pre class="language-text"><code>radeon/BTC_rls.bin radeon/CAICOS_mc.bin radeon/CAICOS_me.bin radeon/CAICOS_pfp.bin
</code></pre></div><p>Но в таком случае требуется включить в конфигурационный файл ядра строку с указанием директории, в которой находятся эти блобы:</p> <div class="language- extra-class"><pre class="language-text"><code>CONFIG_EXTRA_FIRMWARE_DIR=&quot;/lib/firmware&quot;
</code></pre></div><p>Идём далее:</p> <div class="language- extra-class"><pre class="language-text"><code>&lt; &gt; Parallel port support  ---&gt;
-*- Plug and Play support  ---&gt;
</code></pre></div><p>Первое уже вряд ли нужно. Но если у вас есть устройства ( раньше это были все принтеры ), требующие подключения по параллельному порту - включите опцию.</p> <p>Plug and Play включаем.</p> <div class="language- extra-class"><pre class="language-text"><code>[*] Block devices  ---&gt;
    &lt;*&gt; Loopback device support
    &lt;*&gt; RAM block device support
</code></pre></div><p>Блочные устройства. <code>Loopback device support</code> включить обязательно.</p> <p><code>RAM block device support</code> нужен при сборке ядра с initrd, в противном случае - отключить: &quot;выбирайте Y, если хотите использовать часть оперативной памяти как блочное устройство. В этом устройстве вы сможете создавать файловую систему, и использовать ее как обыкновенное блочное устройство (такое как жесткий диск). Обычно его используют для загрузки и сохранения минимальной копии корневой файловой системы при загрузке с флоппи диска, CD-ROM при установке дистрибутива, или на бездисковых рабочих станциях.&quot;</p> <div class="language- extra-class"><pre class="language-text"><code>Misc devices  ---&gt;
</code></pre></div><p>Просмотреть и принять решение включать или не включать то или иное устройство. У автора данный раздел вообще пуст.</p> <div class="language- extra-class"><pre class="language-text"><code>SCSI device support  ---&gt;
  -*- SCSI device support
  [*] legacy /proc/scsi/ support
  *** SCSI support type (disk, tape, CD-ROM) ***
  &lt;*&gt; SCSI disk support
  &lt;*&gt; SCSI CDROM support
  [*]   Enable vendor-specific extensions (for SCSI CDROM)
  &lt;*&gt; SCSI generic support
  [*] Verbose SCSI error reporting (kernel size +=12K)
</code></pre></div><p>Поддержка устройств SCSI. В современных машинах без включения этих опций могут быть не найдены такие устройства как жёсткий диск и CD-привод.</p> <div class="language- extra-class"><pre class="language-text"><code>&lt;*&gt; Serial ATA and Parallel ATA drivers  ---&gt;
    [*] Verbose ATA error reporting
    [*] ATA ACPI Support
    [*] SATA Port Multiplier support
    *** Controllers with non-SFF native interface ***
    &lt;*&gt; AHCI SATA support
</code></pre></div><p>Поддержка устройств SATA. AHCI (Advanced Host Controller Interface) - механизм, позволяющий устройствам SATA пользоваться расширенными функциями.</p> <div class="language- extra-class"><pre class="language-text"><code>[ ] Multiple devices driver support (RAID and LVM)  ---&gt;
</code></pre></div><p>Опции, обеспечивающие использование логических томов и программных RAID-массивов.</p> <div class="language- extra-class"><pre class="language-text"><code>[*] Network device support  ---&gt;
    [*]   Ethernet driver support  ---&gt;
    &lt;*&gt;   PPP (point-to-point protocol) support
    USB Network Adapters  ---&gt;
    [*]   Wireless LAN  ---&gt;
</code></pre></div><p>В <code>Ethernet driver support</code> следует выбрать поддержку устройства вашей сетевой карты Ethernet. PPP может понадобиться тем, кто подключается к интернету с использованием соответствующего протокола. USB Adapters - при наличии у вас поднобного адаптера для выхода в сеть. Wireless LAN - для использования беспроводных сетей стандарта IEEE 802.11. Здесь нужно выбрать соответствующий вашему оборудованию драйвер.</p> <div class="language- extra-class"><pre class="language-text"><code>Input device support  ---&gt;
</code></pre></div><p>Нужен для определения различных устройств ввода как то: мыши, тачпады, тачскрины, джойстики, клавиатура и иные устройства. Предлагается немного побродить по списку и выбрать нужные опции.</p> <div class="language- extra-class"><pre class="language-text"><code>{*} I2C support  ---&gt;
</code></pre></div><p>Поддержка видео в Linux.</p> <div class="language- extra-class"><pre class="language-text"><code>&lt;*&gt; Multimedia support  ---&gt;
    [*] Cameras/video grabbers support
    [*] Media USB Adapters  ---&gt;
    &lt;*&gt; USB Video Class (UVC)
    [*] UVC input events device support
</code></pre></div><p>Поддержка веб-камер и захвата видео.  Нужно включить, если имеется встроенная камера или предполагается подключать камеру внешнюю.</p> <div class="language- extra-class"><pre class="language-text"><code>Graphics support  ---&gt;
  &lt;*&gt; /dev/agpgart (AGP Support)  ---&gt;
  &lt;*&gt;   AMD Opteron/Athlon64 on-CPU GART support
  &lt;*&gt;   Intel 440LX/BX/GX, I8xx and E7x05 chipset support
</code></pre></div><p>Включение поддержки AGP. В примере для видеокарт Intel и Radeon.</p> <div class="language- extra-class"><pre class="language-text"><code>[*] Laptop Hybrid Graphics - GPU switching support
</code></pre></div><p>Включается, если на машине более одной видеокарты. Подробнее об этой проблеме
можно узнать в <a href="/posts/gentoo2/">соответствующем посте</a>.</p> <div class="language- extra-class"><pre class="language-text"><code>&lt;M&gt; Direct Rendering Manager
</code></pre></div><p>Включить DRM - Direct Rendering Manager. Современная вещь, рекомендуется.</p> <div class="language- extra-class"><pre class="language-text"><code>{*} Support for frame buffer devices  ---&gt;
    [*] Enable Video Mode Handling Helpers
    [*] Enable Tile Blitting Support
    [*] EFI-based Framebuffer Support
</code></pre></div><p>Управление поддержкой фреймбуфера. EFI-based Framebuffer Support нужен для систем с UEFI.</p> <div class="language- extra-class"><pre class="language-text"><code>Console display driver support  ---&gt;
   {*} Framebuffer Console support
</code></pre></div><p>Поддержка кадрового буфера в консоли. Включаем.</p> <div class="language- extra-class"><pre class="language-text"><code>[*] Bootup logo  ---&gt;
   [*] Standard 224-color Linux logo
</code></pre></div><p>Включаем пингвинов при загрузке системы 😉</p> <div class="language- extra-class"><pre class="language-text"><code>&lt;*&gt; Sound card support  ---&gt;
    &lt;*&gt;   Advanced Linux Sound Architecture  ---&gt;
</code></pre></div><p>Включение поддержки звуковых устройств. Выбор своего железа из списка.</p> <div class="language- extra-class"><pre class="language-text"><code>[*] USB support  ---&gt;
</code></pre></div><p>Аналогично, только для USB-устройств.</p> <div class="language- extra-class"><pre class="language-text"><code>[*] X86 Platform Specific Device Drivers  ---&gt;
</code></pre></div><p>Имеет смысл посмотреть владельцам ноутбуков. Особенно тем, у кого не
работает контроль яркости экрана или горячие клавиши. Для владельцев MXM видеокарт там же включить:</p> <div class="language- extra-class"><pre class="language-text"><code>&lt;*&gt; WMI Support for MXM Laptop Graphics
</code></pre></div><h2 id="firmware-drivers"><a href="#firmware-drivers" aria-hidden="true" class="header-anchor">#</a> Firmware Drivers</h2> <p><img src="/assets/img/firmware.jpg" alt="firmware"></p> <p>Для включения в ядро сторонних прошивок. Если вы не уверены, что вам нужны какие-либо опции, рекомендуется оставить вариант по-умолчанию.</p> <h2 id="file-systems"><a href="#file-systems" aria-hidden="true" class="header-anchor">#</a> File systems</h2> <p><img src="/assets/img/file_systems.jpg" alt="filesys"></p> <p>Осуществляет поддержку тех или иных файловых систем, поддержку квотирования, а также выбор нативных языков (вернее того, как будут отображаться символы). В целом, в комментариях не нуждается. Единственное замечание: если вы собираете ядро без initrd нужно включить используемые при загрузке файловые системы жёстко, а не модулями.</p> <h2 id="kernel-hacking"><a href="#kernel-hacking" aria-hidden="true" class="header-anchor">#</a> Kernel hacking</h2> <p><img src="/assets/img/kernel_hacking.jpg" alt="kern_hack"></p> <div class="language- extra-class"><pre class="language-text"><code>[*] Magic SysRq key
</code></pre></div><p>Если компьютер завис и не реагирует на команды переключения консоли. Вы можете нажать <code>Alt-PrintScreen-s</code> для записи кеша дисков или <code>Alt-PrintScreen-i</code> (Убить все процессы за исключением init). Механизм нажатия такой: - Нажать <code>Alt</code> - Нажать <code>PrintScreen</code> - Отпустить <code>Alt</code> - Нажать нужную кнопку - Отпустить все.</p> <div class="language- extra-class"><pre class="language-text"><code>-*- Debug Filesystem
</code></pre></div><p>Когда эта опция включена, можно монтировать debugfs в <code>/etc/fstab</code>. Таким образом мы получим директорию <code>/sys/kernel/debug</code>, что очень небесполезно в частности для обладателей двух видеокарт.</p> <h2 id="security-options"><a href="#security-options" aria-hidden="true" class="header-anchor">#</a> Security options</h2> <p><img src="/assets/img/security.jpg" alt="secur"></p> <p>Позволяет увеличить защищенность системы. Можно, например, запретить запуск программ с привилегиями root без специального ключа или с помощью системы SELinux ограничить возможности доступа к файлам самого root. Изменяйте эти опции только если вы знаете что делаете.</p> <h2 id="cryptographic-api"><a href="#cryptographic-api" aria-hidden="true" class="header-anchor">#</a> Cryptographic API</h2> <p><img src="/assets/img/crypto.jpg" alt="cryp"></p> <p>Опции шифрования. Пригодятся, если у вас имеются закодированные файловые системы. Так же как и с предыдущим пунктом: изменяйте эти опции только если вы знаете что делаете.</p> <h2 id="virtualization"><a href="#virtualization" aria-hidden="true" class="header-anchor">#</a> Virtualization</h2> <p><img src="/assets/img/virtualization.jpg" alt="virt"></p> <div class="language- extra-class"><pre class="language-text"><code>&lt;M&gt;  Kernel-based Virtual Machine (KVM) support
&lt;M&gt;  KVM for Intel processors support
&lt; &gt;  KVM for AMD processors support
</code></pre></div><p>Нужно включить, если планируется использовать виртуализацию (конкретно: VirtualBox или QEMU). В противном случае не отмечайте ничего.</p> <h2 id="library-routines"><a href="#library-routines" aria-hidden="true" class="header-anchor">#</a> Library routines</h2> <p><img src="/assets/img/library.jpg" alt="lib"></p> <p>Используется для предоставления модулям функций CRC32 CRC32c. Можете включить</p> <h2 id="посnесnовие"><a href="#посnесnовие" aria-hidden="true" class="header-anchor">#</a> Послесловие</h2> <p>Итак, настройка ядра закончена. Теперь коснёмся вопроса о сборке. Процесс сборки и установки ядра можно выполнить одной командой:</p> <div class="language- extra-class"><pre class="language-text"><code># make bzImage modules modules_install install
</code></pre></div><p>Когда ядро будет собрано, у Вас должны появиться следующие файлы:</p> <div class="language- extra-class"><pre class="language-text"><code>/boot/vmlinuz-3.6.11
/boot/System.map-3.6.11
/boot/initrd-3.6.11.img
</code></pre></div><p>и каталог модулей</p> <div class="language- extra-class"><pre class="language-text"><code>/lib/modules/3.6.11
</code></pre></div><p>И последним шагом подправим строки загрузчика, чтобы можно было загрузиться с новым ядром (пример для grub-legacy):</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># /boot/grub/menu.lst</span>
<span class="token comment">#</span>
default <span class="token number">0</span>
<span class="token function">timeout</span> <span class="token number">30</span>
<span class="token assign-left variable">splashimage</span><span class="token operator">=</span><span class="token punctuation">(</span>hd0,1<span class="token punctuation">)</span>/boot/grub/splash.xpm.gz
title Linux <span class="token number">3.6</span>.11
root <span class="token punctuation">(</span>hd0,1<span class="token punctuation">)</span>
kernel /boot/vmlinuz-3.6.11 <span class="token assign-left variable">root</span><span class="token operator">=</span>/dev/ram0 <span class="token assign-left variable">real_root</span><span class="token operator">=</span>/dev/sda3
initrd /boot/initrd-3.6.11
</code></pre></div><p>Для тех, кому любопытно собрать ядро без initrd, милости прошу:
<a href="http://alv.me/?p=58" target="_blank" rel="noopener noreferrer">лишнему в ядре не место<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>. Хотя и следуя представленным выше указаниям также можно собрать такое ядро. Но статья, приведённая по ссылке, позволит лучше понять зачем это нужно и нужно ли оно вообще.</p> <p>Единственное, что там не указано: как в этом случае будут выглядеть
настройки загрузчика. В них больше не будет указания на initrd — последней
строки — и ram0:</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># /boot/grub/menu.lst</span>
<span class="token comment">#</span>
title Linux <span class="token number">3.6</span>.11
root <span class="token punctuation">(</span>hd0,1<span class="token punctuation">)</span>
kernel /boot/vmlinuz-3.6.11 <span class="token assign-left variable">root</span><span class="token operator">=</span>/dev/sda3
</code></pre></div><p>Если сборка не первая, вы увидите в <code>/boot</code> старое ядро, оно будет выглядеть
как <code>vmlinuz-$KERNEL-VERSION.old</code>. В случае неудачной сборки, вы всегда можете загрузиться со старым ядром.</p> <p><strong>P.S:</strong> при указанном способе сборки в gentoo автоматически не появится initrd. Если он вам нужен, наиболее простой способ: после сборки ядра использовать для его создания <code>genkernel</code>:</p> <div class="language- extra-class"><pre class="language-text"><code># genkernel --install initramfs
</code></pre></div><p><strong>P.S2:</strong> не забудьте добавить своего пользователя в соответствующие группы. Если нет звука, прежде всего проверьте, добавлен ли пользователь в группу <code>audio</code>, если не заводится камера — в группу <code>video</code>.</p> <p>Да, надо бы ещё отметить, что при необходимости можно обратиться к документации ядра.
Располагаются эти файлы в каталоге <code>/usr/src/linux/Documentation</code>. Вот, вроде бы, и всё.</p></div> <div class="tags" data-v-1c67afbc><span data-v-1c67afbc>2013</span> 

  <a href="/?tag=linux" data-v-1c67afbc>
    linux
  </a></div> <div class="prev-next" data-v-326f747b><div class="prev-next__prev" data-v-326f747b><a href="/posts/texreview/" data-v-326f747b>
      Что такое TeX?
    </a></div> <div class="prev-next__between" data-v-326f747b>⤧</div> <div class="prev-next__next" data-v-326f747b><a href="/posts/backup/" data-v-326f747b>
      Ещё один способ резервного копирования
    </a></div></div> <!----></article></main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.6e4996bc.js" defer></script><script src="/assets/js/4.11d3a3db.js" defer></script><script src="/assets/js/3.a76664f0.js" defer></script><script src="/assets/js/28.785693ad.js" defer></script>
  </body>
</html>
